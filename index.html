<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EonFlow Dashboard</title>

  <!-- libs -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- env vars generated at build (OK if 404 for now) -->
  <script src="/env.js"></script>
  <noscript><style>body{background:#0b1220;color:#e5e7eb}#nojs{padding:24px;font:14px system-ui}</style></noscript>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root" class="min-h-screen"></div>
  <noscript><div id="nojs">JavaScript is required to view the EonFlow dashboard.</div></noscript>

  <script type="text/babel">
    // Prefer env var from env.js; otherwise fallback to your Railway API
    const API = (window.__EONFLOW_API__ || "https://web-production-4bc2.up.railway.app");

    function Stat({ label, value }) {
      return (
        <div className="p-4 rounded-2xl bg-slate-900/60 border border-slate-800">
          <div className="text-slate-400 text-sm">{label}</div>
          <div className="text-lg font-semibold">{String(value ?? "—")}</div>
        </div>
      );
    }

    function Card({ title, children }) {
      return (
        <div className="rounded-2xl bg-slate-900/50 border border-slate-800 p-5">
          <div className="font-semibold mb-3">{title}</div>
          {children}
        </div>
      );
    }

    function App(){
      const [userId] = React.useState("550e8400-e29b-41d4-a716-446655440000");
      const [loading, setLoading] = React.useState(false);
      const [history, setHistory] = React.useState([]);
      const [status, setStatus] = React.useState("");

      const fetchHistory = async () => {
        try {
          const res = await fetch(`${API}/executions/${userId}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          setHistory(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          setStatus(`History error: ${err.message || err}`);
        }
      };

      const callAgent = async (path) => {
        setLoading(true);
        setStatus("");
        try {
          const res = await fetch(`${API}${path}/${userId}`, { method: "POST" });
          const body = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(body?.detail || `HTTP ${res.status}`);
          setStatus("Agent run successful");
          await fetchHistory();
        } catch (e) {
          console.error(e);
          setStatus(e.message || "Error");
        } finally {
          setLoading(false);
        }
      };

      React.useEffect(() => { fetchHistory(); }, []);

      return (
        <div className="max-w-5xl mx-auto p-6 space-y-6">
          <header className="flex items-center justify-between">
            <h1 className="text-2xl font-bold">EonFlow Dashboard</h1>
            <button onClick={fetchHistory} className="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              Refresh
            </button>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Stat label="Total Executions (last 25)" value={history.length} />
            <Stat label="Recent Status" value={status || "—"} />
            <Stat label="User" value={userId.slice(0,8) + "…"} />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card title="Daily Digest">
              <p className="text-sm text-slate-400 mb-3">Summarize today’s meetings, Slack mentions, and Notion updates.</p>
              <button disabled={loading} onClick={() => callAgent("/agents/daily-digest")} className="w-full py-2 rounded-xl bg-blue-600 hover:bg-blue-500">
                {loading ? "Running…" : "Run Digest"}
              </button>
            </Card>
            <Card title="Follow-Up Agent">
              <p className="text-sm text-slate-400 mb-3">Suggest post-meeting follow-ups.</p>
              <button disabled={loading} onClick={() => callAgent("/agents/follow-up")} className="w-full py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">
                {loading ? "Running…" : "Run Follow-Up"}
              </button>
            </Card>
            <Card title="Notion Summarizer">
              <p className="text-sm text-slate-400 mb-3">Summarize recent Notion page changes.</p>
              <button disabled={loading} onClick={() => callAgent("/agents/notion-summarizer")} className="w-full py-2 rounded-xl bg-violet-600 hover:bg-violet-500">
                {loading ? "Running…" : "Run Summarizer"}
              </button>
            </Card>
          </div>

          <div className="rounded-2xl bg-slate-900/50 border border-slate-800 p-5 text-xs text-slate-500">
            API: <code>{API || "not set"}</code>
          </div>
        </div>
      );
    }

    // React 18 still supports render() (with a warning). It’s fine for this simple static page.
    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
